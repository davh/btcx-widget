<html>
<head>
    <title>BTCX Project</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <base target="_parent" />
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
	<link href='https://fonts.googleapis.com/css?family=Oxygen:400,700,300' rel='stylesheet' type='text/css'>
	<script src="https://crypto-js.googlecode.com/files/2.5.3-crypto-sha256.js"></script>
	<script src="./jsbn.js"></script>
	<script src="./jsbn2.js"></script>
		
	<!-- Bootstrap -->	
	<link rel="stylesheet" href="bootstrap/3.3.5/css/bootstrap.min.css">
	<link rel="stylesheet" href="bootstrap/3.3.5/css/bootstrap-theme.min.css">
	<script src="bootstrap/3.3.5/js/bootstrap.min.js"></script>

	<STYLE TYPE="text/css">
	label {
	  margin-top: 10px;
	  margin-bottom: 10px;
	  font-weight: normal;
	}

	a:link {
		text-decoration: none;
	}

	a:visited {
		color: blue;
	}


	button {
	}


	.btcx-form .form-control.error {
	  border-bottom: 4px solid red;
	}

	.btcx-form .form-control.correct {
	  border-bottom: 3px solid green;
	}

	a#terms {
		text-decoration: none;
		margin-left: 10px;
	}


	#tooMuch {
		font-size: 11px;
		color: red;
		margin-top: 8px;
	}

	#tooltip {
		margin-top: 3px;
		font-size: 0.8em;
	}

	.submitInformation, .submitConfirmation {
		margin-top: 20px;
	}
	
	.alert{
		margin-bottom: 10px;
	}
	.alert-info{
		margin-top: 15px;
	}
	.radio-input{
		margin: 20px 10px 10px 10px !important;
	}
	.accept-policy {
		margin-top: 10px;
	}

	</STYLE>

</head>

<body onload="parent.postMessage(document.body.scrollHeight, 'http://www.bitcoin.se');">
<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-PLZGKN"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PLZGKN');</script>
<!-- End Google Tag Manager -->

<div class="container-fluid">
<form class="btcx-form" target="_blank" id="purchaseBitcoins" method="GET" action="https://btcx.se/">
	<INPUT type="hidden" name="mode" value="buy">
	<INPUT type="hidden" name="currency" value="btc">
	<INPUT type="hidden" name="action" value="send">
	<INPUT type="hidden" name="apiKey" value="ee3b41f4-0d16-4e99-9c03-831966d5a439">
	
	<div id="bigOrange" class="row">
		<div class="col-md-12 col-xs-12 col-sm-12">
			<div class="alert alert-success" role="alert"><b>Hej!</b> Här kan du snabbt köpa bitcoin och betala med Swish. Max 2000 kr per dag. Oftast har du dina bitcoin på några minuter!</div>					
		</div>
		<div class="col-md-6 col-xs-12 col-sm-6">
			<label>Jag vill köpa för (SEK):</label>
			<input type="text" id="amountSek" class="form-control left" placeholder="0" name="amount" required>
			<div id="btcxSek" class="currency"></div>
		</div>
		<div class="col-md-6 col-xs-12 col-sm-6">
			<label>Ungefärligt belopp (BTC):</label>
			<input type="text" id="amountBtc" class="form-control left" placeholder="0" name="buyAmount" readonly>
			<div class="currency"></div>			
		</div>		
		<div class="col-md-12 col-xs-12 col-sm-12">
			<label>Bitcoinadress (<a href="https://btcx.se/faq#faq2" target="new">hjälp</a>):</label>
			<input type="text" placeholder="Din bitcoinadress" id="btcAdr" class="form-control right" name="buyBitAddress" required>		
		</div>		
		<div class="col-md-6 col-xs-12 col-sm-6">
			<label>Mobilnummer:</label>
			<input type="text" placeholder="Samma nummer som ditt Swish" id="phoneNumber" class="form-control right" name="pinOrPhonenumber" required>				
		</div>
		<div class="col-md-6 col-xs-12 col-sm-6">
			<label>Din email:</label>
			<input type="text" id="email" placeholder="email@example.com" class="form-control right" name="email" required>			
		</div>

		<div class="col-md-12 col-xs-12 col-sm-12">
			<div class="alert alert-info" role="alert">
				<span class="glyphicon glyphicon-info-sign" aria-hidden="true"></span>
				<span>Köpet hanteras av Goobit AB och för att de ska kunna uppfylla Finansinspektionens krav så behövs det (tyvärr) lite fler uppgifter om dig som köper också.</span>
			</div>
		</div>
		
		<div class="col-md-12 col-xs-12 col-sm-12">
			<label>Personnummer:</label>
			<input type="text" id="sweSsn" placeholder="Måste vara samma som ditt BankID" class="form-control right" name="buyPersonNummer" required>
			<div id="tooltip">Format: ååååmmdd-xxxx</div>
		</div>

		<div class="col-md-6 col-xs-12 col-sm-6">
			<label>Förnamn</label>
			<input type="text" id="" placeholder="Ditt förnamn" class="form-control right" name="buyFirstName" required="">
		</div>
		<div class="col-md-6 col-xs-12 col-sm-6">
			<label>Efternamn</label>
			<input type="text" id="" placeholder="Ditt efternamn" class="form-control right" name="buyLastName" required="">
		</div>

		<div class="col-md-12 col-xs-12 col-sm-12">
			<label>Gatuadress</label>
			<input type="text" id="" placeholder="Folkbokföringsadress" class="form-control right" name="buyStreetAddress" required="">
		</div>		

		<div class="col-md-6 col-xs-12 col-sm-6">
			<label>Postnummer</label>
			<input type="text" id="" placeholder="Ditt postnummer" class="form-control right" name="buyPostCode" required="">
		</div>
		<div class="col-md-6 col-xs-12 col-sm-6">
			<label>Postort</label>
			<input type="text" id="" placeholder="Din postort" class="form-control right" name="buyPostCity" required="">
		</div>

		<div class="col-md-12 col-xs-12 col-sm-12">		
			Är du en <a href="https://btcx.se/pep" target="_blank">politiskt utsatt person?</a>   
			  <input class="radio-input" type="radio" name="pepAnswer" id="pepAnswer1" value="False" required />Nej
			  <input class="radio-input" type="radio" name="pepAnswer" id="pepAnswer2" value="True" required />Ja
		</div>
		<div class="col-md-12 col-xs-12 col-sm-12">		
			 <div class="accept-policy">
				<input type="checkbox" required="" id="buyAgreeTerms"  name="buyAgreeTerms" >
				Jag godtar BTCXs <a target="_blank" href="https://btcx.se/villkor">köpvillkor och privacy policy.</a>
			</div>
		</div>
		
		<div class="col-md-12 col-xs-12 col-sm-12">					
			<div class="submitInformation" id="submitInformation">
				<button class="btn btn-default" id="submitButton" type="submit">Beställ nu!</button>
				<a target="_blank" id="terms" href="https://btcx.se/support">Support</a>
			</div>			
			<div class="submitConfirmation alert alert-success" id="submitConfirmation" style="display: none"><b>Klart!</b> Bekräftelse har öppnats i nytt fönster</div>
		</div>
	</div>

</form>
</div>

<SCRIPT TYPE="text/javascript">   
	BigInteger.valueOf = nbv;
	BigInteger.prototype.toByteArrayUnsigned = function () {
		var ba = this.toByteArray();
		if (ba.length) {
			if (ba[0] == 0)
				ba = ba.slice(1);
			return ba.map(function (v) {
				return (v < 0) ? v + 256 : v;
			});
		} else
			return ba;
	};        
	var Bitcoin = {};
	(function () {
		var B58 = Bitcoin.Base58 = {
			alphabet: "123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",
			base: BigInteger.valueOf(58),
			decode: function (input) {
				bi = BigInteger.valueOf(0);
				var leadingZerosNum = 0;
				for (var i = input.length - 1; i >= 0; i--) {
					var alphaIndex = B58.alphabet.indexOf(input[i]);
					if (alphaIndex < 0) {
						throw "Invalid character";
					}
					bi = bi.add(BigInteger.valueOf(alphaIndex)
					.multiply(B58.base.pow(input.length - 1 - i)));
					if (input[i] == "1") leadingZerosNum++;
					else leadingZerosNum = 0;
				}
				var bytes = bi.toByteArrayUnsigned();
				while (leadingZerosNum-- > 0) bytes.unshift(0);
				return bytes;
			}
		};
	})();
	Bitcoin.Address = function (bytes) {
		if ("string" == typeof bytes)
			bytes = Bitcoin.Address.decodeString(bytes);
		this.hash = bytes;
		this.version = Bitcoin.Address.networkVersion;
	};
	Bitcoin.Address.networkVersion = 0x00; // mainnet
	Bitcoin.Address.decodeString = function (string) {
		var bytes = Bitcoin.Base58.decode(string);
		var hash = bytes.slice(0, 21);
		var checksum = Crypto.SHA256(Crypto.SHA256(hash, { asBytes: true }), { asBytes: true });
		if (checksum[0] != bytes[21] ||
			checksum[1] != bytes[22] ||
			checksum[2] != bytes[23] ||
			checksum[3] != bytes[24])
			throw "Checksum validation failed!";
		var version = hash.shift();
		if (version != 0)
			throw "Version " + version + " not supported!";
		return hash;
	};
	function checkBtc(address) {
		try {
			Bitcoin.Address(address);
			return true;
		} catch (err) {
			return false;
		}
	}
</SCRIPT>

<SCRIPT TYPE="text/javascript">
$(document).ready(function(){
        /*
            Hostname Config

        */
		
        var btcxHostName = "https://btcx.se/";
        //

        var btcxBtcRate;

        $.getJSON(btcxHostName + "getRates/").done(function(data) {
            btcxBtcRate = data["buyRates"]["BTC"]["Bitcoin"];
        });


//      $("#bigOrange").hide();
//      $("#btcxButton").click(function(){
//          $("#bigOrange").slideToggle("fast");
//      });

        $("#tooltip").hide();



        $("#sweSsn").focus(function() {
           $("#tooltip").show();
        });

        $("#sweSsn").blur(function() {
           $("#tooltip").hide();
        });

        $("#amountSek").on("input ",function(){
            if ($.isNumeric($(this).val())){
                $("#amountBtc").val($(this).val() * btcxBtcRate);
                if ($(this).val() > 2000){
                    $(this).addClass("error").removeClass("correct");
                    // $("#btcxSek").append('<div id="tooMuch">För att genomföra köp över 2000 SEK per dag så måste du registrera dig på <a href="https://bt.cx">bt.cx</a>. Då får du också ett bättre pris. Bra va?</div>');
                    if ($("#tooMuch").length < 1){

                        $("#btcxSek").append('<div id="tooMuch">För att genomföra köp över 2000 SEK per dag så måste du registrera dig på <a href="https://bt.cx">bt.cx</a>. Då får du också ett bättre pris. Bra va?</div>');
                    }
                    
                } else {
                    $(this).addClass("correct");
                    $("#tooMuch").remove();
                }
            }
        });

    var validatePersonalNumber = function(input) {
        console.log(input);
        // Check valid length & form
        if (!input) return false;

        if (input.indexOf('-') == -1) {
            if (input.length === 10) {
                input = input.slice(0, 6) + "-" + input.slice(6);
            } else {
                input = input.slice(0, 8) + "-" + input.slice(8);
            }
        }
        if (!input.match(/^(\d{4})(\d{2})(\d{2})\-(\d{4})$/)) return false;

        // Clean input
        input = input.replace('-', '');
        if (input.length == 12) {
            input = input.substring(2);
        }

        // Declare variables
        var d = new Date(((!!RegExp.$1) ? RegExp.$1 : RegExp.$5), (((!!RegExp.$2) ? RegExp.$2 : RegExp.$6)-1), ((!!RegExp.$3) ? RegExp.$3 : RegExp.$7)),
                sum = 0,
                numdigits = input.length,
                parity = numdigits % 2,
                i,
                digit;

        // Check valid date
        if (Object.prototype.toString.call(d) !== "[object Date]" || isNaN(d.getTime())) return false;

        // Check luhn algorithm
        for (i = 0; i < numdigits; i = i + 1) {
            digit = parseInt(input.charAt(i))
            if (i % 2 == parity) digit *= 2;
            if (digit > 9) digit -= 9;
            sum += digit;
        }
        return (sum % 10) == 0;
    };

    function validateEmail(email) {
        var re = /^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;
        return re.test(email);
    }

    function checkPhoneNumber(p) {
        var phoneRe = /^[0-9]\d{2}[2-9]\d{2}\d{4}$/;
        var digits = p.replace(/\D/g, "");
        return (digits.match(phoneRe) !== null);
    }

    $("#sweSsn").on("input keyup", function(){
        var ssn = $(this).val();
        var trueSsn = validatePersonalNumber(ssn);
        // if (ssn == ""){
        //  console.log("no ssn");
        //  $(this).removeClass("error");
        // }
        if (trueSsn == false) {
            $(this).addClass("error").removeClass("correct");
        } else {
            $(this).addClass("correct");
        }
    });

    $("#email").on("input keyup", function(e){
        if (e.keyCode == 8) {
        }
        var varEmail = $(this).val();
        var trueEmail = validateEmail(varEmail);
        if (trueEmail == false) {
            $(this).addClass("error").removeClass("correct");
        } else {
            $(this).addClass("correct");
        }
        
    });

    $("#btcAdr").on("input keyup", function(){
        var varBtc = $(this).val();
        var trueBtc = checkBtc(varBtc);
        if (trueBtc == false) {
            $(this).addClass("error").removeClass("correct");
        } else {
            $(this).addClass("correct");
        }
        
    });

    $("#phoneNumber").on("input keyup", function(){
        var varPhone = $(this).val();
        var truePhone = checkPhoneNumber(varPhone);
        if (truePhone == false || null) {
            $(this).addClass("error").removeClass("correct");
        } else {
            $(this).addClass("correct");
        }
        
    });

    /*
        Validate form before submission.
    */
    $("#purchaseBitcoins").submit(function(event){
        
        var phone = $("#phoneNumber").val();
        var btc = $("#btcAdr").val();
        var email = $("#email").val();
        var ssn = $("#sweSsn").val();
        var amountSek = $("#amountSek").val();  
        // console.log(checkPhoneNumber(phone));
        // console.log(checkBtc(btc));
        // console.log(validateEmail(email);
        // console.log(validatePersonalNumber(ssn));

        if (checkPhoneNumber(phone) && checkBtc(btc) && validateEmail(email) && validatePersonalNumber(ssn) && amountSek < 2001 ){
            dataLayer.push({'Buy bitcoin amount': amountSek});
            dataLayer.push({'event': 'buy-bitcoin-event'});
            $("#submitInformation").hide();
            $("#submitConfirmation").show();
        } else {
            event.preventDefault();
        }
        
    });



}); //end of document ready

</SCRIPT>


</body>
</html>